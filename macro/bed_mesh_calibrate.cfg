[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
  SAVE_GCODE_STATE NAME=BMESH_STATE

  {% if "x" not in printer.toolhead.homed_axes
        or "y" not in printer.toolhead.homed_axes
        or "z" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  M117 Running Switchy BED_MESH_CALIBRATE...
  DEPLOY_PROBE

  STATUS_MESHING
  _BED_MESH_CALIBRATE {rawparams}
  G0 Z10 F12000
  STATUS_READY

  RETRACT_PROBE
  RESTORE_GCODE_STATE NAME=BMESH_STATE

